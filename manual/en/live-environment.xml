<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE chapter PUBLIC "-//OASIS//DTD DocBook XML V4.4//EN" "http://www.oasis-open.org/docbook/xml/4.4/docbookx.dtd">
<chapter id="live-environment">
  <title>The Live environment</title>
  <section>
    <title>Swap space</title>
    <para>FIXME</para>
  </section>
  <section id="hostname">
    <title>Hostname</title>
    <para>The name of host running live system can be set with the <command>hostname</command> parameter into the <command>--bootappend-live</command> option of <filename>lh_config</filename>, e.g.: <screen>lh_config --bootappend-live "hostname=myhost"</screen> This parameter can also be used in kernel command line.</para>
  </section>
  <section id="live-user">
    <title>The Live user</title>
    <para>Username FIXME.</para>
    <para>One important consideration is that the live user is created by <filename>live-initramfs</filename> during bootup, it is not created by <filename>live-helper</filename> when building the image.</para>
    <para>You can specify additional groups that the live user will belong to by preseeding the <command>passwd/user-default-groups</command> debconf value. For example, to add the live user to the <command>fuse</command> group, add the following to a file in the <filename class="directory">config/chroot_local-preseed</filename> directory:</para>
    <screen> debconf passwd/user-default-groups string audio cdrom dialout floppy video plugdev netdev powerdev fuse </screen>
    <para>For more information about debconf preseeding, please see <xref linkend="debconf-preseed"/>.</para>
  </section>
  <section id="language">
    <title>Language</title>
    <para>When the live system boots, language is involved in three steps: <itemizedlist><listitem><simpara>the locale generation</simpara></listitem><listitem><simpara>setting the keyboard layout for the console</simpara></listitem><listitem><simpara>setting the keyboard layout for X</simpara></listitem></itemizedlist></para>
    <para>To define the locale that should be generated, use the <command>locale</command> parameter into the <command>--bootappend-live</command> option of <filename>lh_config</filename>, e.g.: <screen>lh_config --bootappend-live "locale=sv_SE.utf8"</screen> This parameter can also be used in kernel command line. You can specify a locale by a two-letters code, or for better control, by a full <userinput><parameter>language</parameter>_<parameter>country</parameter>.<parameter>encoding</parameter></userinput> word.</para>
    <para>Both the console and X keyboard configuration depends on the <command>keyb</command> parameter of the <command>--bootappend-live</command> option. Valid options for X keyboard layouts can be found in <filename>/etc/X11/xkb/base.xml</filename> (rather limited to two-letters country codes). To find the value (the two characters) corresponding to a language try searching for the english name of the nation where the language is spoken, e.g: <screen>$ grep -i sweden -C3 /etc/X11/xkb/base.xml | grep name &lt;name&gt;se&lt;/name&gt; </screen> To get the locale files for swedish generated and a swedish keyboard layout in X use: <screen>lh_config --bootappend-live "locale=sv_SE.utf8 keyb=se"</screen> </para>
    <para> A list of the valid values of the keyboards for the console can be figured with the following command: <screen>for i in `find /usr/share/keymaps/ -iname "*kmap.gz"`; do basename $i | head -c -9; echo; done | sort | less </screen> To make the console keyboard use a swedish layout use <screen>lh_config --bootappend-live "locale=sv_SE.utf8 keyb=se-latin1"</screen> </para>
    <para>Alternatively, you can use the <literal>console-setup</literal> package, a tool to let you configure console layout using X (XKB) definitions; you can then setup your keyboard layout more precisely with <literal>klayout</literal>, <literal>kvariant</literal>, <literal>koptions</literal> and <literal>kmodel</literal> variables; <command>live-initramfs</command> will use also these parameters for X configuration. For example, to set up a french system with a french-dvorak layout (called BÃ©po) on a TypeMatrix keyboard, both in console and X11, use: <screen>lh_config --bootappend-live \ "locale=fr_FR.UTF-8 klayout=fr kvariant=bepo kmodel=tm2030usb"</screen> Note that on old versions of <literal>console-setup</literal> (i.e. Lenny's one), you'll need to setup also the <literal>keyb</literal> variable to the <literal>klayout</literal>'s value. </para>
  </section>
  <section id="persistence">
    <title>Persistence</title>
    <para>A live cd paradigm is a preinstalled system which runs from read-only media, like a cdrom, where writes and modifications do not survive reboots of the host hardware which runs it.</para>
    <para>A Debian Live system is a generalization of this paradigm and thus supports other media in addition to CDs; but still, in its default behaviour, it should be considered read-only and all the runtime evolutions of the system are lost at shutdown.</para>
    <para>Persistence is a common name for different kinds of solutions for saving across reboots some, or all, of this runtime evolution of the system. To understand how it could work it could be handy to know that even if the system is booted and run from read-only media, modification to the files and directories are written on writable media, typically a ram disk (tmpfs) and ram disks' data do not survive reboots.</para>
    <para>The data stored on this ramdisk should be saved on a writable persistent medium like a Hard Disk, a USB key, a network share or even a session of a multisession (re)writable CD/DVD. All these media are supported in Debian Live in different ways, and all but the last one require a special boot parameter to be specified at boot time: <command>persistent</command>.</para>
    <section>
      <title>Full persistence</title>
      <para>By 'full persistence' it is meant that instead of using a tmpfs for storing modifications to the read-only media (with the copy-on-write, COW, system) a writable partition is used. In order to use this feature a partition with a clean writable supported filesystem on it labeled "live-rw" must be attached on the system at bootime and the system must be started with the boot parameter 'persistent'. This partition could be an ext2 partition on the hard disk or on a usb key created with, e.g.:</para>
      <screen> # mkfs.ext2 -L live-rw /dev/sdb1 </screen>
      <para>If you already have a partition on your device, you could just change the label with one of the following:</para>
      <screen> # tune2fs -L live-rw /dev/sdb1 # for ext2,3,4 filesystems # dosfslabel /dev/sdb1 live-rw # for a fat filesystem </screen>
      <para>But since live system users cannot always use a hard drive partition, and considering that most USB keys have poor write speeds, 'full' persistence could be also used with just image files, so you could create a file representing a partition and put this image file even on a NTFS partition of a foreign OS, with something like:</para>
      <screen> $ dd if=/dev/null of=live-rw bs=1G seek=1 # for a 1GB sized image file $ /sbin/mkfs.ext2 -F live-rw </screen>
      <para>Then copy the <command>live-rw</command> file to a writable partition and reboot with the boot parameter 'persistent'.</para>
    </section>
    <section>
      <title>Home automounting</title>
      <para>If during the boot a partition (filesystem) image file or a partition labeled <command>home-rw</command> is discovered, this filesystem will be directly mounted as <command>/home</command>, thus permitting persistence of files that belong to e.g. the default user. It can be combined with full persistence.</para>
    </section>
    <section>
      <title>Snapshots</title>
      <para>Snapshots are collections of files and directories which are not mounted while running but which are copied from a persistent device to the system (tmpfs) at boot and which are resynced at reboot/shutdown of the system. The content of a snapshot could reside on a partition or an image file (like the above mentioned types) labeled <command>live-sn</command>, but it defaults to a simple cpio archive named <command>live-sn.cpio.gz</command>. As above, at boot time, the block devices connected to the system are traversed to see if a partition or a file named like that could be found. A power interruption during runtime could lead to data loss, hence a tool invoked <command>live-snapshot --refresh</command> could be called to sync important changes. This type of persistence, since it does not write continuously to the persistent media, is the most flash-based device friendly and the fastest of all the persistence systems.</para>
      <para> A /home version of snapshot exists too and its label is <command>home-sn.*</command>; it works the same as the main snapshot but it is only applied to /home.</para>
      <para>Snapshots cannot currently handle file deletion but full persistence and home automounting can.</para>
    </section>
    <section>
      <title>Persistent SubText</title>
      <para>If a user would need multiple persistent storage of the same type for different locations or testing, such as <command>live-rw-nonwork</command> and <command>live-rw-work</command>, the boot parameter <command>persistent-subtext</command> used in conjuntion with the boot parameter <command>persistent</command> will allow for multiple but unique persistent media. An example would be if a user wanted to use a persistent partition labeled <command>live-sn-subText</command> they would use the boot parameters of: <command>persistent</command> <command>persistent-subtext=subText</command>.</para>
    </section>
    <section>
      <title>Partial remastering</title>
      <para>The runtime modification of the tmpfs could be collected using live-snapshot in a squashfs and added to the cd by remastering the iso in the case of cd-r or adding a session to multisession cd/dvd(rw); live-initramfs mounts all /live filesystem in order or with the module bootparameter.</para>
    </section>
  </section>
</chapter>
